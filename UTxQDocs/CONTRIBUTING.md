## Code Structure For UTxQuantico

The code of the `UTxQCompiler` and `UTxQlib` is very simple and readable for anyone who has prior experience with python, Go or Rust. `UTxQ` is an open source language and aims to develop under Nation of Developers of all levels. Please note that the name `Quantico` comes from word `Quantum` meaning Ultra Small Particles which brings a cool feature of Ultra-Light Compiler which works as fast as moving Electrons. Therefore, it is requested to all contributers to keep these ideas constant in their code.    


The code for UTxQCompiler resides in  `[UTxQCompiler/](UTxQCompiler/)`

ToDo:- Create a directory Structure flowchart here. 

Currently the following files are present in `[UTxQCompiler/](UTxQCompiler/)'
/
1. `xQMain.xq` The entry point.
- UTxQ figures out the build mode.
- Constructs the UTxQCompiler object (`struct UTxQ`).
- Creates a list of .xq files that need to be parsed.
- Creates a xQParser object for each file and runs `xQParse()` on them (this should work concurrently in the future). The xQParser emits C or x64 code directly. For performance reasons, there are no intermediate steps (no AST or Assembly code generation).
- If the parsing is successful, a single C file is generated by merging the output from the xQParsers and carefully arranging all definitions (C is a single pass language).
- Finally, a C compiler is called to compile this C file and generate an executable or a library.

2. `xQParser.xq` The core of the UTxQCompiler. This is the largest file. `xQParse()` method asks the xQScanner to generate a list of tokens for the file it needs to parse. Then it simply goes through all the tokens one by one.

   In UTxQ objects can be used before declaration, so there are 2 passes. During the first pass it only looks at declarations and skips function bodies. It memorizes all function signatures, types, consts, etc. During the second pass it looks at function bodies and generates C  (e.g. `qxcgen('if ($expr) {'`) or machine code (e.g. `gen.mov(EDI, 1)`).

   The formatter is embedded in xQParser. Correctly formatted tokens are emitted as they are parsed. This allowed to simplify the compiler and avoid duplication, but slowed it down a bit. In the future this will be fixed with build flags and separate binaries for C generation, machine code generation, and formatting. This way there will be no unnecessary branching and function calls.
   
3. `xQScanner.xq` The xQScanner's job is to parse a list of characters and convert them to tokens. It also takes care of string interpolation, which is a mess at the moment.

4. `xQToken.xq` This is simply a list of all tokens, their string values, and a couple of helper functions.

5. `xQTable.xq` UTxQ creates one table object that is shared by all parsers. It contains all types, consts, and functions, as well as several helpers to search for objects by name, register new objects, modify types' fields, etc.

6. `QxCgen.xq` The small `QxCgen` struct helps generate C code. It's also shared by all xQParsers. It has a couple of functions that allow to go back and set something that was previously unknown (like with `a := 0` => `int a = 0;`). Some of these functions are hacky and need improvements and simplifications.

7. `xQFn.xq` Handles declaring and calling normal and async functions and methods. This file is about 1000 lines of code, and has some complex logic. It needs to be cleaned up and simplified a bit.

8. `xQJson.xq` defines the json code generation. This file will be removed once V supports comptime code generation, and it will be possible to do this using the language's tools.

9. `x64/` is the directory with all the machine code generation logic. It will be available in early July. Obviously this is the most complex part of the compiler. It defines a set of functions that translate assembly instructions to machine code, it builds complicated binaries from scratch byte by byte. It manually builds all headers, segments, sections, symtable, relocations, etc. Right now it only has basic support of the x64 platform/Mach-O format, and it can only generate `.o` files, which then have to be linked with `lld`.

The rest of the directories are UTxQLib modules: `UTxQBuiltin/` (xQStrings, xQArrays, xQMaps), `UTxQTime/`, `UTxQos/`, etc. Their documentation is pretty clear.
